# RaftStack: Index Standards Registry

Scan for standards files and maintain a registry. Works with any directory structure.

## Purpose

Keep track of all standards and context files in the project, regardless of where they're stored.

## Tool Usage

**IMPORTANT:** Always use the `AskUserQuestion` tool for:
- Location negotiation
- Drift resolution decisions
- Follow-up options

Never use plain text questions - always use the structured `AskUserQuestion` tool.

## Phase 1: Scan for Standards

Search common locations for standards files:

1. **Standard locations:**
   - `.claude/standards/**/*.md`
   - `.claude/context/**/*.md`
   - `docs/standards/**/*.md`
   - `standards/**/*.md`
   - `*.standard.md` (root level)

2. **Context files:**
   - `CONSTITUTION.md`
   - `.claude/context/constitution.md`
   - `docs/constitution.md`

3. **Skills (RaftStack-provided):**
   - `.claude/skills/*/SKILL.md`

## Phase 2: Analyze Each File

For each discovered file, extract:

- **Path:** Full path from project root
- **Title:** First H1 heading
- **Domain:** Inferred from path or content (API, React, Database, etc.)
- **Last Modified:** File modification date
- **Summary:** First paragraph or purpose section

## Phase 3: Generate Registry

Create or update a registry file:

```markdown
# Standards Registry

> Auto-generated by `/raftstack/index`
> Last updated: [timestamp]

## Project Context

| File | Description | Last Modified |
|------|-------------|---------------|
| [path] | [title/summary] | [date] |

## Standards by Domain

### API/Backend
| Standard | Path | Last Modified |
|----------|------|---------------|
| [name] | [path] | [date] |

### React/Frontend
| Standard | Path | Last Modified |
|----------|------|---------------|
| [name] | [path] | [date] |

### Database
| Standard | Path | Last Modified |
|----------|------|---------------|
| [name] | [path] | [date] |

### Other
| Standard | Path | Last Modified |
|----------|------|---------------|
| [name] | [path] | [date] |

## RaftStack Skills

| Skill | Path | Description |
|-------|------|-------------|
| React | `.claude/skills/react/SKILL.md` | React 19+ patterns |
| Backend | `.claude/skills/backend/SKILL.md` | Clean architecture |
| Database | `.claude/skills/database/SKILL.md` | PostgreSQL/Drizzle |
| SEO | `.claude/skills/seo/SKILL.md` | Technical SEO |
| Code Quality | `.claude/skills/code-quality/SKILL.md` | General patterns |

## Usage

Reference standards in conversation:
- `@path/to/standard.md` - Load full standard
- `/raftstack/inject [domain]` - Get relevant standards for a task
```

## Phase 4: Location Negotiation

Use `AskUserQuestion` with these options:
- Option A: `.claude/standards/REGISTRY.md` - With standards (Recommended)
- Option B: `.claude/REGISTRY.md` - In Claude folder
- Option C: `docs/REGISTRY.md` - With documentation
- Option D: Other (let user specify)

If a registry already exists, update it in place.

## Phase 5: Drift Detection

Compare current codebase against documented standards:

1. **Check for orphaned standards:**
   - Standards that reference files/patterns no longer in codebase
   - Flag for review

2. **Check for undocumented patterns:**
   - Significant code areas without corresponding standards
   - Suggest running `/raftstack/discover` for those areas

3. **Check for inconsistencies:**
   - Code that violates documented standards
   - Flag specific files for review

## Phase 6: Indexing Summary

After scanning and creating the registry, present:

```markdown
## ‚úÖ Standards Indexing Completed

### üéØ Registry Overview
- **Total Standards:** [N] documents
- **Domains Covered:** [list domains]
- **Skills Available:** [N] RaftStack skills
- **Registry Location:** `[path]`

### üìã What Was Found
| Domain | Standards | Last Updated |
|--------|-----------|--------------|
| API/Backend | [N] | [most recent date] |
| React/Frontend | [N] | [most recent date] |
| Database | [N] | [most recent date] |
| Other | [N] | [most recent date] |

### üîç Drift Report

#### Orphaned Standards
| Standard | Issue | Recommendation |
|----------|-------|----------------|
| [path] | [References deleted file] | [Remove or update] |

#### Undocumented Areas
| Area | Files | Recommendation |
|------|-------|----------------|
| `src/auth/` | [N files] | Run `/raftstack/discover auth` |
| `src/utils/` | [N files] | Run `/raftstack/discover utils` |

#### Potential Violations
| File | Standard | Issue |
|------|----------|-------|
| `src/api/users.ts:45` | Error Handling | [Description] |

### ‚ö†Ô∏è Action Items
1. **[High Priority]** [Action needed] - [Why]
2. **[Medium Priority]** [Action needed] - [Why]
3. **[Low Priority]** [Action needed] - [Why]

### üîÑ What's Next
- **Option A:** Fix orphaned standards - Update or remove stale references
- **Option B:** Document undocumented areas - Run discover for flagged areas
- **Option C:** Review violations - Check flagged files for compliance
- **Option D:** Done for now

**Your options:** [A] Fix orphaned [B] Document areas [C] Review violations [D] Done
```

Use `AskUserQuestion` for options.

## Phase 7: Drift Resolution

If user chooses to address drift:

### Orphaned Standards
```markdown
## Resolving Orphaned Standard: [Standard Name]

**Issue:** References `[old-path]` which no longer exists.

**Options:**
- [A] Update standard to reference new location (if moved)
- [B] Remove the outdated reference
- [C] Delete the standard entirely
- [D] Skip for now
```

Use `AskUserQuestion` for each orphaned standard.

### Undocumented Areas
For each undocumented area, suggest:
- Run `/raftstack/discover [area]` to document patterns

### Violations
For each violation, present:
- The standard that's being violated
- The specific code that violates it
- Options to fix or mark as acceptable deviation

## Automation Suggestions

After indexing, suggest based on findings:

1. **If many undocumented areas:** "Run `/raftstack/discover` for key areas"

2. **If standards are old:** "Some standards haven't been updated in 90+ days. Review for accuracy."

3. **If violations found:** "Review flagged files for standard compliance"

## Example Output

```markdown
## ‚úÖ Standards Indexing Completed

### üéØ Registry Overview
- **Total Standards:** 5 documents
- **Domains Covered:** API, React, Database
- **Skills Available:** 5 RaftStack skills
- **Registry Location:** `.claude/standards/REGISTRY.md`

### üìã What Was Found
| Domain | Standards | Last Updated |
|--------|-----------|--------------|
| API/Backend | 2 | 2024-01-20 |
| React/Frontend | 1 | 2024-01-18 |
| Database | 1 | 2024-01-15 |
| Other | 1 | 2024-01-10 |

### üîç Drift Report

#### Undocumented Areas
| Area | Files | Recommendation |
|------|-------|----------------|
| `src/auth/` | 8 files | Run `/raftstack/discover auth` |
| `src/middleware/` | 3 files | Run `/raftstack/discover middleware` |

#### Potential Violations
| File | Standard | Issue |
|------|----------|-------|
| `src/api/users.ts:45` | Error Handling | Missing correlation ID |

### ‚ö†Ô∏è Action Items
1. **[Medium Priority]** Document auth patterns - 8 files without standards
2. **[Low Priority]** Review error handling - 1 potential violation

**Your options:** [A] Document auth area [B] Review violations [C] Update old standards [D] Done
```
